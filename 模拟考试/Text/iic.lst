C51 COMPILER V9.00   IIC                                                                   03/22/2019 13:32:46 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN iic.obj
COMPILER INVOKED BY: C:\Keil_v4\C51\BIN\C51.EXE Use\iic.c BROWSE DEBUG OBJECTEXTEND PRINT(.\iic.lst) OBJECT(iic.obj)

line level    source

   1          /*
   2            程序说明: IIC总线驱动程序
   3            软件环境: Keil uVision 4.10 
   4            硬件环境: CT107单片机综合实训平台 8051，12MHz
   5            日    期: 2011-8-9
   6          */
   7          
   8          #include "iic.h"
   9           
  10          
  11          #define DELAY_TIME 30
  12          
  13          #define SlaveAddrW 0xA0
  14          #define SlaveAddrR 0xA1
  15          
  16          //总线引脚定义
  17          sbit SDA = P2^1;  /* 数据线 */
  18          sbit SCL = P2^0;  /* 时钟线 */
  19          
  20          void IIC_Delay(unsigned char i)
  21          {
  22   1          do{_nop_();}
  23   1          while(i--);        
  24   1      }
  25          //总线启动条件
  26          void IIC_Start(void)
  27          {
  28   1          SDA = 1;
  29   1          SCL = 1;
  30   1          IIC_Delay(DELAY_TIME);
  31   1          SDA = 0;
  32   1          IIC_Delay(DELAY_TIME);
  33   1          SCL = 0;    
  34   1      }
  35          
  36          //总线停止条件
  37          void IIC_Stop(void)
  38          {
  39   1          SDA = 0;
  40   1          SCL = 1;
  41   1          IIC_Delay(DELAY_TIME);
  42   1          SDA = 1;
  43   1          IIC_Delay(DELAY_TIME);
  44   1      }
  45          
  46          //发送应答
  47          void IIC_SendAck(bit ackbit)
  48          {
  49   1          SCL = 0;
  50   1          SDA = ackbit;                                       // 0：应答，1：非应答
  51   1          IIC_Delay(DELAY_TIME);
  52   1          SCL = 1;
  53   1          IIC_Delay(DELAY_TIME);
  54   1          SCL = 0; 
  55   1          SDA = 1;
C51 COMPILER V9.00   IIC                                                                   03/22/2019 13:32:46 PAGE 2   

  56   1          IIC_Delay(DELAY_TIME);
  57   1      }
  58          
  59          //等待应答
  60          bit IIC_WaitAck(void)
  61          {
  62   1          bit ackbit;
  63   1              
  64   1          SCL  = 1;
  65   1          IIC_Delay(DELAY_TIME);
  66   1          ackbit = SDA;
  67   1          SCL = 0;
  68   1          IIC_Delay(DELAY_TIME);
  69   1          return ackbit;
  70   1      }
  71          
  72          //通过I2C总线发送数据
  73          void IIC_SendByte(unsigned char byt)
  74          {
  75   1          unsigned char i;
  76   1      
  77   1          for(i=0; i<8; i++)
  78   1          {
  79   2              SCL  = 0;
  80   2              IIC_Delay(DELAY_TIME);
  81   2              if(byt & 0x80) SDA  = 1;
  82   2              else SDA  = 0;
  83   2              IIC_Delay(DELAY_TIME);
  84   2              SCL = 1;
  85   2              byt <<= 1;
  86   2              IIC_Delay(DELAY_TIME);
  87   2          }
  88   1          SCL  = 0;  
  89   1      }
  90          
  91          //从I2C总线上接收数据
  92          unsigned char IIC_RecByte(void)
  93          {
  94   1          unsigned char i, da;
  95   1          for(i=0; i<8; i++)
  96   1          {   
  97   2              SCL = 1;
  98   2              IIC_Delay(DELAY_TIME);
  99   2              da <<= 1;
 100   2              if(SDA) da |= 1;
 101   2              SCL = 0;
 102   2              IIC_Delay(DELAY_TIME);
 103   2          }
 104   1          return da;    
 105   1      }
 106          uchar Read_AD(uchar addr)
 107          {
 108   1              uchar temp;
 109   1              IIC_Start();
 110   1              IIC_SendByte(0x90);
 111   1              IIC_WaitAck();
 112   1              IIC_SendByte(addr);
 113   1              IIC_WaitAck();
 114   1              IIC_Stop();
 115   1              IIC_Start();
 116   1              IIC_SendByte(0x91);
 117   1              IIC_WaitAck();
C51 COMPILER V9.00   IIC                                                                   03/22/2019 13:32:46 PAGE 3   

 118   1              temp = IIC_RecByte();
 119   1                 IIC_WaitAck();
 120   1                 IIC_Stop();
 121   1                 return temp;
 122   1      }
 123          void EEPROM_Write(uchar addr,uchar dat)
 124          {
 125   1              IIC_Start();
 126   1              IIC_SendByte(0xa0);
 127   1              IIC_WaitAck();
 128   1              IIC_SendByte(addr);
 129   1              IIC_WaitAck();
 130   1              IIC_SendByte(dat);
 131   1              IIC_WaitAck();
 132   1              IIC_Stop();
 133   1      }
 134          uchar EEPROM_Read(uchar addr)
 135          {
 136   1              uchar temp;
 137   1              IIC_Start();
 138   1              IIC_SendByte(0xa0);
 139   1              IIC_WaitAck();
 140   1              IIC_SendByte(addr);
 141   1              IIC_WaitAck();
 142   1              IIC_Stop();
 143   1              IIC_Start();
 144   1              IIC_SendByte(0xa1);
 145   1              IIC_WaitAck();
 146   1              temp = IIC_RecByte();
 147   1              IIC_WaitAck();
 148   1              IIC_Stop();
 149   1                 return temp;
 150   1      }
 151          
 152          
 153          
 154          
 155          
 156          
 157          
 158          
 159          
 160          
 161          
 162          
 163          
 164          
 165          
 166          
 167          
 168          
 169          
 170          
 171          
 172          
 173          
 174          
 175          
 176          
 177          
 178          
 179          
C51 COMPILER V9.00   IIC                                                                   03/22/2019 13:32:46 PAGE 4   

 180          
 181          
 182          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    276    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
